<div class="bulletins-container">
  <div class="header">
    <h1>üìä Gestion des Bulletins</h1>
    <p class="subtitle">G√©n√©rez et g√©rez les bulletins scolaires</p>
  </div>

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üìã</div>
      <div class="stat-content">
        <h3>{{ stats.totalBulletins || 0 }}</h3>
        <p>Bulletins g√©n√©r√©s</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üë•</div>
      <div class="stat-content">
        <h3>{{ stats.totalEleves || 0 }}</h3>
        <p>√âl√®ves concern√©s</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-content">
        <h3>{{ stats.moyenneGenerale || 0 | number:'1.2-2' }}</h3>
        <p>Moyenne g√©n√©rale</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üéØ</div>
      <div class="stat-content">
        <h3>{{ stats.meilleurEleve || 'N/A' }}</h3>
        <p>Meilleur √©l√®ve</p>
      </div>
    </div>
  </div>

  <!-- Filtres et actions -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <label for="classeFilter">Classe</label>
        <select id="classeFilter" [(ngModel)]="selectedClasseId" (change)="onClasseChange()" class="filter-select">
          <option value="">Toutes les classes</option>
          <option *ngFor="let classe of classes" [value]="classe.id">
            {{ classe.nom }} - {{ classe.niveau }}
          </option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="periodeFilter">P√©riode</label>
        <select id="periodeFilter" [(ngModel)]="selectedPeriode" (change)="onPeriodeChange()" class="filter-select">
          <option value="">Toutes les p√©riodes</option>
          <option value="trimestre1">1er Trimestre</option>
          <option value="trimestre2">2√®me Trimestre</option>
          <option value="trimestre3">3√®me Trimestre</option>
          <option value="annuel">Annuel</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="searchFilter">Rechercher</label>
        <input 
          type="text" 
          id="searchFilter"
          [(ngModel)]="searchTerm" 
          (ngModelChange)="onSearchChange()" 
          placeholder="Nom de l'√©l√®ve..." 
          class="filter-input">
      </div>
    </div>

    <div class="actions-row">
      <button (click)="genererBulletins()" class="btn-primary" [disabled]="!selectedClasseId">
        <span class="btn-icon">üìä</span>
        G√©n√©rer les bulletins
      </button>
      <button (click)="exporterBulletins()" class="btn-secondary" [disabled]="!selectedClasseId || generating">
        <span class="btn-icon">üìÑ</span>
        <span *ngIf="!generating">Exporter PDF</span>
        <span *ngIf="generating">Export...</span>
      </button>
      <button (click)="envoyerBulletinsParEmail()" class="btn-outline" [disabled]="!selectedClasseId || generating">
        <span class="btn-icon">üìß</span>
        <span *ngIf="!generating">Envoyer par email</span>
        <span *ngIf="generating">Envoi...</span>
      </button>
      <button (click)="imprimerBulletins()" class="btn-outline" [disabled]="filteredBulletins.length === 0">
        <span class="btn-icon">üñ®Ô∏è</span>
        Imprimer tout
      </button>
    </div>
  </div>

  <!-- Liste des bulletins -->
  <div class="bulletins-section">
    <div *ngIf="filteredBulletins.length > 0; else noBulletins" class="bulletins-grid">
      <div *ngFor="let bulletin of filteredBulletins" class="bulletin-card">
        <div class="bulletin-header">
          <div class="eleve-info">
            <h3>{{ bulletin.eleve?.nom }} {{ bulletin.eleve?.prenom }}</h3>
            <p class="eleve-details">
              <span class="detail-item">Classe: {{ bulletin.eleve?.classe?.nom || 'Non assign√©e' }}</span>
              <span class="detail-item">P√©riode: {{ bulletin.periode || 'Non sp√©cifi√©e' }}</span>
            </p>
          </div>
          <div class="bulletin-stats">
            <div class="moyenne-display" 
                 [class.excellent]="bulletin.moyenne >= 16"
                 [class.bon]="bulletin.moyenne >= 14 && bulletin.moyenne < 16"
                 [class.moyen]="bulletin.moyenne >= 10 && bulletin.moyenne < 14"
                 [class.insuffisant]="bulletin.moyenne < 10">
              <span class="moyenne-value">{{ bulletin.moyenne | number:'1.2-2' }}</span>
              <span class="moyenne-label">/20</span>
            </div>
            <div class="rang-display">
              <span class="rang-label">Rang</span>
              <span class="rang-value">{{ bulletin.rang || 'N/A' }}</span>
            </div>
          </div>
        </div>

        <div class="bulletin-details">
          <div class="detail-row">
            <div class="detail-item">
              <span class="detail-label">Mati√®res √©valu√©es:</span>
              <span class="detail-value">{{ bulletin.nombre_matieres || 0 }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Date de cr√©ation:</span>
              <span class="detail-value">{{ bulletin.created_at | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
          
          <div class="notes-summary" *ngIf="bulletin.notes && bulletin.notes.length > 0">
            <h4>Notes par mati√®re</h4>
            <div class="notes-grid">
              <div *ngFor="let note of bulletin.notes.slice(0, 3)" class="note-item">
                <span class="matiere-name">{{ note.matiere?.nom || 'Mati√®re' }}</span>
                <span class="note-value" 
                      [class.excellent]="note.note >= 16"
                      [class.bon]="note.note >= 14 && note.note < 16"
                      [class.moyen]="note.note >= 10 && note.note < 14"
                      [class.insuffisant]="note.note < 10">
                  {{ note.note }}/20
                </span>
              </div>
              <div *ngIf="bulletin.notes.length > 3" class="more-notes">
                +{{ bulletin.notes.length - 3 }} autres mati√®res
              </div>
            </div>
          </div>
        </div>

        <div class="bulletin-actions">
          <button (click)="voirDetailBulletin(bulletin.id)" class="btn-secondary">
            <span class="btn-icon">üëÅÔ∏è</span>
            Voir d√©tail
          </button>
          <button (click)="modifierBulletin(bulletin.id)" class="btn-primary">
            <span class="btn-icon">‚úèÔ∏è</span>
            Modifier
          </button>
          <button (click)="genererPdfBulletin(bulletin)" class="btn-outline" [disabled]="generating">
            <span class="btn-icon">üìÑ</span>
            <span *ngIf="!generating">G√©n√©rer PDF</span>
            <span *ngIf="generating">G√©n√©ration...</span>
          </button>
          <button (click)="envoyerBulletinParEmail(bulletin)" class="btn-outline" [disabled]="generating">
            <span class="btn-icon">üìß</span>
            <span *ngIf="!generating">Envoyer email</span>
            <span *ngIf="generating">Envoi...</span>
          </button>
          <button (click)="imprimerBulletin(bulletin)" class="btn-outline" [disabled]="generating">
            <span class="btn-icon">üñ®Ô∏è</span>
            <span *ngIf="!generating">Imprimer</span>
            <span *ngIf="generating">Impression...</span>
          </button>
        </div>
      </div>
    </div>

    <ng-template #noBulletins>
      <div class="no-data">
        <div class="no-data-icon">üìä</div>
        <h3>Aucun bulletin trouv√©</h3>
        <p *ngIf="selectedClasseId">
          Aucun bulletin n'a √©t√© g√©n√©r√© pour cette classe. 
          <button (click)="genererBulletins()" class="btn-primary">G√©n√©rer les bulletins</button>
        </p>
        <p *ngIf="!selectedClasseId">
          S√©lectionnez une classe pour voir les bulletins ou g√©n√©rer de nouveaux bulletins.
        </p>
      </div>
    </ng-template>
  </div>

  <!-- Modal de g√©n√©ration -->
  <div class="modal-overlay" *ngIf="showGenerationModal" (click)="closeGenerationModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>G√©n√©rer les bulletins</h2>
        <button (click)="closeGenerationModal()" class="close-btn">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="generation-info">
          <p>Vous √™tes sur le point de g√©n√©rer les bulletins pour la classe <strong>{{ getClasseName() }}</strong>.</p>
          <p>Cette action va cr√©er des bulletins pour tous les √©l√®ves de cette classe.</p>
        </div>

        <div class="form-group">
          <label for="periodeGeneration">P√©riode</label>
          <select id="periodeGeneration" [(ngModel)]="periodeGeneration" class="form-control">
            <option value="trimestre1">1er Trimestre</option>
            <option value="trimestre2">2√®me Trimestre</option>
            <option value="trimestre3">3√®me Trimestre</option>
            <option value="annuel">Annuel</option>
          </select>
        </div>

        <div class="eleves-preview" *ngIf="elevesClasse.length > 0">
          <h4>√âl√®ves concern√©s ({{ elevesClasse.length }})</h4>
          <div class="eleves-list">
            <div *ngFor="let eleve of elevesClasse.slice(0, 5)" class="eleve-item">
              {{ eleve.nom }} {{ eleve.prenom }}
            </div>
            <div *ngIf="elevesClasse.length > 5" class="more-eleves">
              +{{ elevesClasse.length - 5 }} autres √©l√®ves
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="closeGenerationModal()" class="btn-secondary">
          Annuler
        </button>
        <button (click)="confirmerGeneration()" class="btn-primary" [disabled]="generating">
          <span *ngIf="generating" class="loading-spinner"></span>
          <span *ngIf="!generating">{{ generating ? 'G√©n√©ration...' : 'G√©n√©rer' }}</span>
        </button>
      </div>
    </div>
  </div>
</div> 